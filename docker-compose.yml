services:
  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - APP_DOMAIN=${APP_DOMAIN}
      - BOT_DOMAIN=${BOT_DOMAIN}
      - N8N_DOMAIN=${N8N_DOMAIN}
      - PANEL_DOMAIN=${PANEL_DOMAIN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - /srv/stack/gestionale:/var/www/gestionale:ro
    depends_on:
      - php
      - panel
      - n8n
      - phpmyadmin
    networks:
      - stack

  php:
    image: php:8.2-fpm
    container_name: php
    restart: unless-stopped
    working_dir: /var/www/gestionale
    command: sh -c "apt-get update && apt-get install -y default-libmysqlclient-dev libicu-dev libzip-dev libxml2-dev && docker-php-ext-install pdo_mysql mysqli intl zip xml && mkdir -p /var/www/gestionale/public/assets && chown -R www-data:www-data /var/www/gestionale/public/assets && chmod -R 775 /var/www/gestionale/public/assets && php-fpm -F"
    expose:
      - "9000"
    env_file:
      - ../.env
    volumes:
      - /srv/stack/gestionale:/var/www/gestionale
    networks:
      - stack
